<div class="text-center pages-head">
    <span class="font-pages-head">‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏≤‡∏° - ‡∏ï‡∏≠‡∏ö</span>
</div>
</div>
<img src="<?php echo base_url('docs/welcome-btm-light-other.png'); ?>">
<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -->
<div class="modal fade" id="guestConfirmModal" tabindex="-1" aria-labelledby="guestConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"
            style="border: none; border-radius: 20px; box-shadow: 0 20px 60px rgba(173, 216, 230, 0.2), 0 8px 25px rgba(0,0,0,0.08); background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%); overflow: hidden;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, rgba(173, 216, 230, 0.1) 0%, rgba(135, 206, 250, 0.1) 100%); color: #2c3e50; border-radius: 20px 20px 0 0; border-bottom: 1px solid rgba(173, 216, 230, 0.2); backdrop-filter: blur(10px);">
                <h5 class="modal-title" id="guestConfirmModalLabel"
                    style="font-weight: 600; color: #4682b4; width: 100%; text-align: center;">
                    <i class="fas fa-sparkles me-2" style="color: #87ceeb;"></i>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
                </h5>
            </div>
            <div class="modal-body text-center"
                style="padding: 2.5rem; background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);">
                <div class="mb-4">
                    <div
                        style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, rgba(173, 216, 230, 0.15) 0%, rgba(135, 206, 250, 0.15) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(173, 216, 230, 0.3);">
                        <i class="fas fa-user-circle"
                            style="font-size: 2.5rem; color: #4682b4; text-shadow: 0 2px 8px rgba(173, 216, 230, 0.4);"></i>
                    </div>
                </div>
                <h5 class="mb-3" style="color: #2c3e50; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
                <p class="text-muted mb-4" style="font-size: 1.05rem; line-height: 1.6; color: #6c757d;">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>

                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-lg" onclick="redirectToLogin()"
                        style="background: linear-gradient(135deg, #87ceeb 0%, #4682b4 100%); border: none; color: white; border-radius: 15px; padding: 1rem 1.5rem; font-weight: 600; box-shadow: 0 6px 20px rgba(135, 206, 250, 0.4); transition: all 0.3s ease; font-size: 1.1rem;">
                        <i class="fas fa-sign-in-alt me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                    <button type="button" class="btn btn-lg" onclick="proceedAsGuest()"
                        style="background: rgba(173, 216, 230, 0.08); border: 2px solid rgba(173, 216, 230, 0.3); color: #4682b4; border-radius: 15px; padding: 1rem 1.5rem; font-weight: 600; transition: all 0.3s ease; font-size: 1.1rem; backdrop-filter: blur(10px);">
                        <i class="fas fa-edit me-2"></i>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>

                <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° decorative elements -->
                <div
                    style="position: absolute; top: -50px; right: -50px; width: 100px; height: 100px; background: linear-gradient(135deg, rgba(173, 216, 230, 0.08) 0%, rgba(135, 206, 250, 0.08) 100%); border-radius: 50%; z-index: -1;">
                </div>
                <div
                    style="position: absolute; bottom: -30px; left: -30px; width: 60px; height: 60px; background: linear-gradient(135deg, rgba(135, 206, 250, 0.08) 0%, rgba(173, 216, 230, 0.08) 100%); border-radius: 50%; z-index: -1;">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-center pages-head">
    <span class="font-pages-head"
        style="font-size: 2.8rem; font-weight: 700; text-shadow: 1px 1px 3px rgba(108, 117, 125, 0.2);">‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ñ‡∏≤‡∏° -
        ‡∏ï‡∏≠‡∏ö</span>
</div>

<div class="bg-pages" style="background: #ffffff; min-height: 100vh; padding: 2rem 0;">
    <div class="container-pages-news" style="position: relative; z-index: 10;">
        <div class="container-pages-news mb-5 mt-5"
            style="position: relative; z-index: 10; background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); padding: 2rem; margin: 0 auto; max-width: 900px; overflow: hidden;"
            id="q_a">

            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° decorative element -->
            <div
                style="position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, #6c757d, #495057, #6c757d); background-size: 200% 100%; animation: gradientShift 3s ease-in-out infinite;">
            </div>



            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
            <div class="d-flex justify-content-end mb-3">
                <a href="<?php echo site_url('Pages/q_a'); ?>" class="btn view-all-btn" style="background: linear-gradient(135deg, #4682b4 0%, #87ceeb 100%); 
                  border: none; 
                  color: white; 
                  padding: 0.7rem 1.5rem; 
                  border-radius: 12px; 
                  font-size: 0.95rem; 
                  font-weight: 600; 
                  transition: all 0.3s ease; 
                  box-shadow: 0 4px 15px rgba(70, 130, 180, 0.3); 
                  text-decoration: none;
                  position: relative;
                  overflow: hidden;">
                    <span style="position: relative; z-index: 2;">
                        <i class="fas fa-list me-2"></i>‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </span>
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; z-index: 1;"
                        class="btn-shine-view"></div>
                </a>
            </div>



            <div class="underline">
                <form id="qaForm" action="<?php echo site_url('Pages/add_q_a'); ?>" method="post"
                    class="form-horizontal" enctype="multipart/form-data" onsubmit="return false;">
                    <input type="hidden" name="form_token" id="formToken" value="">
                    <br>

                    <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° -->
                    <div class="form-group mb-4">
                        <div class="form-label-wrapper"
                            style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.08) 0%, rgba(134, 142, 150, 0.08) 100%); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                            <label class="form-label"
                                style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #495057;">
                                <i class="fas fa-question-circle me-2" style="color: #6c757d;"></i>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°<span
                                    style="color: #e74c3c; margin-left: 0.2rem;">*</span>
                            </label>
                        </div>
                        <div class="col-sm-12">
                            <input type="text" name="q_a_msg" class="form-control" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."
                                style="border: none; border-radius: 15px; padding: 1rem; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(108, 117, 125, 0.15); background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); backdrop-filter: blur(10px);">
                            <div class="invalid-feedback" id="q_a_msg_feedback"></div>
                        </div>
                    </div>

                    <br>
                    <div class="row">
                        <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
                        <div class="col-6">
                            <div class="form-group mb-4">
                                <div class="form-label-wrapper"
                                    style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.08) 0%, rgba(134, 142, 150, 0.08) 100%); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                    <label class="form-label"
                                        style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #495057;">
                                        <i class="fas fa-user me-2" style="color: #6c757d;"></i>‡∏ä‡∏∑‡πà‡∏≠<span
                                            style="color: #e74c3c; margin-left: 0.2rem;">*</span>
                                    </label>
                                </div>
                                <div class="col-sm-12">
                                    <input type="text" name="q_a_by" class="form-control" required
                                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ"
                                        style="border: none; border-radius: 15px; padding: 1rem; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(108, 117, 125, 0.15); background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); backdrop-filter: blur(10px);">
                                    <div class="invalid-feedback" id="q_a_by_feedback"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
                        <div class="col-6">
                            <div class="form-group mb-4">
                                <div class="form-label-wrapper"
                                    style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.08) 0%, rgba(134, 142, 150, 0.08) 100%); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                    <label class="form-label"
                                        style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #495057;">
                                        <i class="fas fa-envelope me-2" style="color: #6c757d;"></i>‡∏≠‡∏µ‡πÄ‡∏°‡∏•<span
                                            style="color: #e74c3c; margin-left: 0.2rem;">*</span>
                                    </label>
                                </div>
                                <div class="col-sm-12">
                                    <input type="email" name="q_a_email" class="form-control" required
                                        placeholder="‡πÄ‡∏ä‡πà‡∏ô somchai@gmail.com"
                                        style="border: none; border-radius: 15px; padding: 1rem; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(108, 117, 125, 0.15); background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); backdrop-filter: blur(10px);">
                                    <div class="invalid-feedback" id="q_a_email_feedback"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <br>

                    <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
                    <div class="form-group mb-4">
                        <div class="form-label-wrapper"
                            style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.08) 0%, rgba(134, 142, 150, 0.08) 100%); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                            <label for="exampleFormControlTextarea1" class="form-label"
                                style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #495057;">
                                <i class="fas fa-align-left me-2" style="color: #6c757d;"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î<span
                                    style="color: #e74c3c; margin-left: 0.2rem;">*</span>
                            </label>
                        </div>
                        <div class="col-sm-12">
                            <textarea name="q_a_detail" class="form-control" id="exampleFormControlTextarea1" rows="6"
                                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                                style="border: none; border-radius: 15px; padding: 1rem; font-size: 1.1rem; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(108, 117, 125, 0.15); background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); backdrop-filter: blur(10px); resize: vertical;"></textarea>
                            <div class="invalid-feedback" id="q_a_detail_feedback"></div>
                        </div>
                    </div>

                    <br>

                    <div class="row" style="padding-bottom: 20px;">
                        <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                        <div class="col-9">
                            <div class="form-group">
                                <div class="form-label-wrapper"
                                    style="background: linear-gradient(135deg, rgba(108, 117, 125, 0.08) 0%, rgba(134, 142, 150, 0.08) 100%); border-radius: 12px; padding: 0.8rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px); transition: all 0.3s ease;">
                                    <label class="form-label"
                                        style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #495057;">
                                        <i class="fas fa-images me-2" style="color: #6c757d;"></i>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°<small
                                            style="color: #6c757d; font-weight: 400; margin-left: 0.5rem;">(‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ)</small>
                                    </label>
                                </div>
                                <div class="col-sm-12">
                                    <!-- File Upload Zone -->
                                    <div class="file-upload-wrapper"
                                        style="border: 2px dashed #dee2e6; border-radius: 15px; padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); transition: all 0.3s ease; cursor: pointer; box-shadow: 0 6px 20px rgba(108, 117, 125, 0.15); backdrop-filter: blur(10px);"
                                        ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                                        ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                                        <div id="upload-placeholder" class="upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt"
                                                style="font-size: 2rem; color: #6c757d; margin-bottom: 0.5rem;"></i>
                                            <p style="margin: 0; color: #6c757d; font-size: 1rem;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                                ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                                            <small class="text-muted mt-2 d-block">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, JPEG, PNG (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5
                                                ‡∏£‡∏π‡∏õ)(‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 MB)</small>
                                        </div>
                                    </div>
                                    <input type="file" id="q_a_imgs" name="q_a_imgs[]" class="form-control"
                                        accept="image/*" multiple onchange="handleFileSelect(this)"
                                        style="display: none;">

                                    <!-- File Preview Area -->
                                    <div id="file-preview-area" class="file-preview-area mt-3" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted" style="font-size: 0.9rem;">
                                                <i class="fas fa-images me-1"></i>‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span
                                                    id="file-count">0</span>/5)
                                            </span>
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="clearAllFiles()"
                                                style="border-radius: 8px; font-size: 0.8rem;">
                                                <i class="fas fa-times me-1"></i>‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                            </button>
                                        </div>
                                        <div id="preview-container" class="preview-container"
                                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; max-height: 300px; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á -->
                        <div class="col-3">
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" id="submitQaBtn" class="btn modern-submit-btn"
                                    onclick="handleQaSubmit(event)"
                                    style="background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%); border: none; color: #2d5a3d; padding: 1rem 2rem; border-radius: 15px; font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(136, 216, 163, 0.3); position: relative; overflow: hidden; min-width: 150px;">
                                    <span style="position: relative; z-index: 2;">
                                        <i class="fas fa-paper-plane me-2"></i>‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ
                                    </span>
                                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; z-index: 1;"
                                        class="btn-shine"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° -->
<style>
    /* CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    .view-all-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(70, 130, 180, 0.4) !important;
        background: linear-gradient(135deg, #1e90ff 0%, #4682b4 100%) !important;
        color: white !important;
        text-decoration: none !important;
    }

    .view-all-btn:hover .btn-shine-view {
        left: 100%;
    }

    .view-all-btn:active {
        transform: translateY(-1px);
    }

    .view-all-btn:focus {
        outline: none;
        box-shadow: 0 6px 20px rgba(70, 130, 180, 0.4) !important;
    }

    /* Responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
    @media (max-width: 768px) {
        .view-all-btn {
            font-size: 0.85rem !important;
            padding: 0.6rem 1.2rem !important;
        }
    }
</style>


<style>
    @keyframes gradientShift {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° hover effect ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö form labels */
    .form-label-wrapper:hover {
        background: linear-gradient(135deg, rgba(108, 117, 125, 0.12) 0%, rgba(134, 142, 150, 0.12) 100%) !important;
        box-shadow: 0 6px 16px rgba(108, 117, 125, 0.2) !important;
        transform: translateY(-2px);
    }

    .form-control:focus {
        border-color: transparent !important;
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.25) !important;
        transform: translateY(-1px);
        background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%) !important;
    }

    .modern-submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(136, 216, 163, 0.4) !important;
        background: linear-gradient(135deg, #88d8a3 0%, #7dd87f 100%) !important;
    }

    .modern-submit-btn:hover .btn-shine {
        left: 100%;
    }

    .modern-submit-btn:active {
        transform: translateY(-1px);
    }

    /* File Upload Styles */
    .file-upload-wrapper {
        transition: all 0.3s ease;
    }

    .file-upload-wrapper:hover {
        background: linear-gradient(135deg, #f1f3f4 0%, #e9ecef 100%) !important;
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.2) !important;
        transform: translateY(-2px);
        border-color: #6c757d !important;
    }

    .file-upload-wrapper.drag-over {
        background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%) !important;
        border-color: #2196f3 !important;
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3) !important;
        transform: scale(1.02);
    }

    /* File Preview Styles */
    .preview-item {
        position: relative;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .preview-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .preview-image {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 6px 6px 0 0;
    }

    .preview-info {
        padding: 0.5rem;
        background: #f8f9fa;
    }

    .preview-name {
        font-size: 0.7rem;
        color: #495057;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }

    .preview-size {
        font-size: 0.6rem;
        color: #6c757d;
        margin: 0;
    }

    .remove-file {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(4px);
    }

    .remove-file:hover {
        background: rgba(220, 53, 69, 1);
        transform: scale(1.1);
    }

    /* Progress animation */
    @keyframes uploadProgress {
        0% {
            width: 0%;
        }

        100% {
            width: 100%;
        }
    }

    .upload-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        border-radius: 0 0 6px 6px;
        animation: uploadProgress 1.5s ease-in-out;
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° hover effects ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal */
    .modal-body button:hover {
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    .modal-body button:first-of-type:hover {
        background: linear-gradient(135deg, #4682b4 0%, #1e90ff 100%) !important;
        box-shadow: 0 8px 25px rgba(135, 206, 250, 0.5) !important;
    }

    .modal-body button:last-of-type:hover {
        background: linear-gradient(135deg, rgba(173, 216, 230, 0.15) 0%, rgba(135, 206, 250, 0.15) 100%) !important;
        border-color: rgba(173, 216, 230, 0.5) !important;
        box-shadow: 0 6px 20px rgba(173, 216, 230, 0.3) !important;
    }

    .modal-body button:active {
        transform: translateY(0);
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö modal */
    .modal.fade .modal-dialog {
        transform: scale(0.8) translateY(-50px);
        transition: all 0.3s ease;
    }

    .modal.show .modal-dialog {
        transform: scale(1) translateY(0);
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° glassmorphism effect */
    .modal-header {
        backdrop-filter: blur(10px) !important;
    }

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° loading animation */
    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .font-pages-head {
            font-size: 2rem !important;
        }

        .container-pages-news {
            margin: 0 1rem !important;
            padding: 1.5rem !important;
        }

        .row .col-6 {
            width: 100% !important;
            margin-bottom: 1rem;
        }

        .col-9,
        .col-3 {
            width: 100% !important;
        }

        .preview-container {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
        }
    }
</style>

<!-- Font Awesome ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Bootstrap CSS ‡πÅ‡∏•‡∏∞ JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // ==============================================
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handling
    // ==============================================

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° error handling ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô console error
    window.addEventListener('error', function (e) {
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏à‡∏≤‡∏Å extension ‡∏´‡∏£‡∏∑‡∏≠ external script
        if (e.message && (e.message.includes('message channel') || e.message.includes('check_login_status'))) {
            e.preventDefault();
            return true;
        }
    });

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡πÄ‡∏û‡∏¥‡πà‡∏° check_login_status function ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    function check_login_status() {
        try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            return typeof window.isUserLoggedIn !== 'undefined' ? window.isUserLoggedIn : false;
        } catch (error) {
            console.log('Check login status error (ignored):', error);
            return false;
        }
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 3: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏à‡∏≤‡∏Å undefined variables
    const safeGetVariable = (varName, defaultValue = null) => {
        try {
            return typeof window[varName] !== 'undefined' ? window[varName] : defaultValue;
        } catch (e) {
            return defaultValue;
        }
    };

    // ==============================================
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    // ==============================================

    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ login ‡∏à‡∏≤‡∏Å PHP (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°)
    const isUserLoggedIn = <?= json_encode($is_logged_in); ?>;
    const userInfo = <?= json_encode($user_info); ?>;

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ guest
    let hasConfirmedAsGuest = isUserLoggedIn; // ‡∏ñ‡πâ‡∏≤ login ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö modal instance
    let guestModalInstance = null;

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    let selectedFiles = [];
    const maxFiles = 5;
    const maxFileSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
    let formSubmitting = false;

    // Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• login status
    console.log('Login Status:', isUserLoggedIn);
    console.log('User Info:', userInfo);

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
    // ==============================================

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á form token
    function generateFormToken() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ field ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    function updateFormFieldsBasedOnLoginStatus() {
        try {
            const nameField = document.querySelector('input[name="q_a_by"]');
            const emailField = document.querySelector('input[name="q_a_email"]');

            console.log('üîß userInfo structure:', userInfo);

            if (isUserLoggedIn && userInfo) {
                let userName = '';
                let userEmail = '';

                // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å Model ‡πÅ‡∏•‡∏∞ Controller
                if (userInfo.user_info) {
                    // ‡∏à‡∏≤‡∏Å Model: userInfo.user_info.email
                    userName = userInfo.user_info.name || '';
                    userEmail = userInfo.user_info.email || userInfo.user_info.username || '';
                } else {
                    // ‡∏à‡∏≤‡∏Å Controller ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á: userInfo.email
                    userName = userInfo.name || '';
                    userEmail = userInfo.email || userInfo.username || '';
                }

                // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ email ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å root level
                if (!userEmail) {
                    userEmail = userInfo.email || userInfo.username || '';
                }

                console.log('üìß Final Email:', userEmail);
                console.log('üë§ Final Name:', userName);

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Name field
                if (nameField && userName) {
                    nameField.value = userName;
                    nameField.readOnly = true;
                    nameField.style.backgroundColor = '#f8f9fa';
                    nameField.style.cursor = 'not-allowed';
                    console.log('‚úÖ Name field updated');
                }

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Email field
                if (emailField && userEmail) {
                    emailField.value = userEmail;
                    emailField.readOnly = true;
                    emailField.style.backgroundColor = '#f8f9fa';
                    emailField.style.cursor = 'not-allowed';
                    console.log('‚úÖ Email field updated');
                }

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                if (userName || userEmail) {
                    addLoginInfoMessage(nameField, '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                    addLoginInfoMessage(emailField, '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                }

            } else {
                console.log('üë§ Setting up for guest user');

                // Reset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö guest
                [nameField, emailField].forEach(field => {
                    if (field) {
                        field.readOnly = false;
                        field.style.backgroundColor = '';
                        field.style.cursor = '';
                        field.value = '';
                    }
                });

                // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                document.querySelectorAll('.login-info').forEach(info => info.remove());
            }
        } catch (error) {
            console.error('‚ùå Form update error:', error);
        }
    }

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
    // ==============================================

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
    function handleFileSelect(input) {
        if (input._processing) {
            console.log('File selection already in progress, skipping...');
            return;
        }

        input._processing = true;
        console.log('Starting file selection process...');

        const files = Array.from(input.files);

        if (files.length === 0) {
            input._processing = false;
            return;
        }

        if (selectedFiles.length + files.length > maxFiles) {
            showAlert('warning', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î', `‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`);
            input._processing = false;
            input.value = '';
            return;
        }

        let validFiles = [];
        let duplicateCount = 0;

        for (let file of files) {
            if (!validateFile(file)) {
                input._processing = false;
                input.value = '';
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥
            const fileSignature = `${file.name}_${file.size}_${file.type}`;
            const isDuplicate = selectedFiles.some(existingFile => {
                const existingSignature = `${existingFile.name}_${existingFile.size}_${existingFile.type}`;
                return existingSignature === fileSignature;
            });

            if (isDuplicate) {
                duplicateCount++;
                continue;
            }

            file.id = Date.now() + Math.random() + Math.random();
            validFiles.push(file);
        }

        if (duplicateCount > 0) {
            showAlert('info', '‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥', `‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥ ${duplicateCount} ‡πÑ‡∏ü‡∏•‡πå ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`, 3000);
        }

        selectedFiles = [...selectedFiles, ...validFiles];
        updateFileDisplay();

        setTimeout(() => {
            input.value = '';
            input._processing = false;
        }, 100);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå
    function validateFile(file) {
        if (!allowedTypes.includes(file.type.toLowerCase())) {
            showAlert('error', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå JPG, JPEG, PNG, GIF ‡πÅ‡∏•‡∏∞ WebP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            return false;
        }

        if (file.size > maxFileSize) {
            showAlert('error', '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', `‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${maxFileSize / (1024 * 1024)} MB`);
            return false;
        }

        return true;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateFileDisplay() {
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const previewArea = document.getElementById('file-preview-area');
        const previewContainer = document.getElementById('preview-container');
        const fileCount = document.getElementById('file-count');

        if (selectedFiles.length === 0) {
            uploadPlaceholder.style.display = 'block';
            previewArea.style.display = 'none';
            return;
        }

        uploadPlaceholder.style.display = 'none';
        previewArea.style.display = 'block';
        fileCount.textContent = selectedFiles.length;

        previewContainer.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const previewItem = createPreviewItem(file, index);
            previewContainer.appendChild(previewItem);
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á preview item
    function createPreviewItem(file, index) {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.setAttribute('data-file-id', file.id);

        const img = document.createElement('img');
        img.className = 'preview-image';
        img.alt = file.name;

        const reader = new FileReader();
        reader.onload = function (e) {
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        const info = document.createElement('div');
        info.className = 'preview-info';

        const name = document.createElement('p');
        name.className = 'preview-name';
        name.textContent = file.name;
        name.title = file.name;

        const size = document.createElement('p');
        size.className = 'preview-size';
        size.textContent = formatFileSize(file.size);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-file';
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.title = '‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ';
        removeBtn.onclick = () => removeFile(file.id);

        info.appendChild(name);
        info.appendChild(size);

        div.appendChild(img);
        div.appendChild(info);
        div.appendChild(removeBtn);

        const progress = document.createElement('div');
        progress.className = 'upload-progress';
        div.appendChild(progress);

        return div;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
    function removeFile(fileId) {
        selectedFiles = selectedFiles.filter(file => file.id !== fileId);
        updateFileDisplay();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function clearAllFiles() {
        selectedFiles = [];
        updateFileDisplay();
        showAlert('info', '‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß', '‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 2000);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Drag & Drop
    // ==============================================

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }

    function handleDragEnter(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        if (!e.currentTarget.contains(e.relatedTarget)) {
            e.currentTarget.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files);
        const imageFiles = files.filter(file => file.type.startsWith('image/'));

        if (imageFiles.length !== files.length) {
            showAlert('warning', '‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', '‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
        }

        if (imageFiles.length === 0) {
            showAlert('error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            return;
        }

        if (selectedFiles.length + imageFiles.length > maxFiles) {
            showAlert('warning', '‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î', `‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`);
            return;
        }

        let validFiles = [];
        let invalidCount = 0;
        let duplicateCount = 0;

        for (let file of imageFiles) {
            if (!validateFile(file)) {
                invalidCount++;
                continue;
            }

            const fileSignature = `${file.name}_${file.size}_${file.type}`;
            const isDuplicate = selectedFiles.some(existingFile => {
                const existingSignature = `${existingFile.name}_${existingFile.size}_${existingFile.type}`;
                return existingSignature === fileSignature;
            });

            if (isDuplicate) {
                duplicateCount++;
                continue;
            }

            file.id = Date.now() + Math.random() + Math.random();
            validFiles.push(file);
        }

        selectedFiles = [...selectedFiles, ...validFiles];

        if (validFiles.length > 0) {
            updateFileDisplay();
            showAlert('success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå ${validFiles.length} ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 2000);
        }

        if (duplicateCount > 0 || invalidCount > 0) {
            let message = '';
            if (duplicateCount > 0) message += `‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥ ${duplicateCount} ‡πÑ‡∏ü‡∏•‡πå `;
            if (invalidCount > 0) message += `‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${invalidCount} ‡πÑ‡∏ü‡∏•‡πå`;
            showAlert('warning', '‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ', message.trim());
        }
    }

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    // ==============================================

    function showAlert(icon, title, text, timer = null) {
        const config = {
            icon: icon,
            title: title,
            text: text,
            confirmButtonColor: '#6c757d',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        };

        if (timer) {
            config.timer = timer;
            config.showConfirmButton = false;
            config.toast = true;
            config.position = 'top-end';
        }

        Swal.fire(config);
    }

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    // ==============================================

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏° reCAPTCHA
    function handleQaSubmit(event) {
        event.preventDefault();

        try {
            if (formSubmitting) {
                console.log('Form submission already in progress');
                return false;
            }

            if (!isUserLoggedIn && !hasConfirmedAsGuest) {
                console.log('üë§ Guest user needs confirmation');
                showModal();
            } else {
                console.log('‚úÖ User authorized, submitting form');
                submitForm();
            }
        } catch (error) {
            console.error('Handle submit error:', error);
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        }

        return false;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô submitForm() ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° reCAPTCHA
    function submitForm() {
        try {
            const form = document.getElementById('qaForm');

            if (!form) {
                throw new Error('Form not found');
            }

            if (form.checkValidity()) {
                if (formSubmitting) {
                    return;
                }

                formSubmitting = true;

                const submitBtn = document.getElementById('submitQaBtn');
                const originalContent = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

                // *** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠ reCAPTCHA token ***
                executeRecaptchaAndSubmit(form, submitBtn, originalContent);
            } else {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å');
            }
        } catch (error) {
            console.error('Submit form error:', error);
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            formSubmitting = false;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠ reCAPTCHA token ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    function executeRecaptchaAndSubmit(form, submitBtn, originalContent) {
        try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ reCAPTCHA
            if (!window.RECAPTCHA_SITE_KEY) {
                console.warn('‚ö†Ô∏è reCAPTCHA Site Key ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ - ‡∏Ç‡πâ‡∏≤‡∏° reCAPTCHA ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Development');

                if (window.SKIP_RECAPTCHA_FOR_DEV) {
                    console.log('üîß Development mode: ‡∏Ç‡πâ‡∏≤‡∏° reCAPTCHA ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á');
                    performFormSubmission(form, submitBtn, originalContent, null);
                    return;
                }

                resetSubmitButton(submitBtn, originalContent);
                showAlert('error', '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
                return;
            }

            if (!window.recaptchaReady) {
                console.warn('‚ö†Ô∏è reCAPTCHA ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° - ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                resetSubmitButton(submitBtn, originalContent);
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', '‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                return;
            }

            // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î reCAPTCHA action ‡πÅ‡∏•‡∏∞ source ‡∏ï‡∏≤‡∏° user type (FLEXIBLE VERSION)
            let recaptchaAction = 'qa_public_submit'; // default ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
            let userTypeDetected = 'public';
            let sourceType = 'qa_form';

            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö user type ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
            if (window.isUserLoggedIn && window.userInfo) {
                try {
                    console.log('üîç User info structure:', window.userInfo);

                    let userType = null;
                    let userId = null;

                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    if (window.userInfo.user_type) {
                        userType = window.userInfo.user_type;
                    } else if (window.userInfo.type) {
                        userType = window.userInfo.type;
                    } else if (window.userInfo.system) {
                        userType = window.userInfo.system;
                    } else if (window.userInfo.level) {
                        userType = window.userInfo.level;
                    } else if (window.userInfo.m_level) {
                        userType = window.userInfo.m_level;
                    }

                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö user ID
                    if (window.userInfo.m_id) {
                        userId = window.userInfo.m_id;
                        userType = userType || 'staff';
                    } else if (window.userInfo.user_id) {
                        userId = window.userInfo.user_id;
                    } else if (window.userInfo.id) {
                        userId = window.userInfo.id;
                    }

                    console.log('üîç User type detection details:', {
                        userType: userType,
                        userId: userId,
                        rawUserInfo: window.userInfo
                    });

                    // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î staff levels ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    const staffLevels = [
                        'staff', 'admin', 'system_admin', 'super_admin', 'user_admin',
                        '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'administrator',
                        '1', '2', '3', '4', '5'
                    ];

                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô staff ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å userType ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                    const isStaff = userType && (
                        staffLevels.includes(String(userType).toLowerCase()) ||
                        staffLevels.includes(userType)
                    );

                    if (isStaff) {
                        recaptchaAction = 'qa_admin_submit';
                        userTypeDetected = 'staff';
                        sourceType = 'staff_portal';
                        console.log('üë§ Staff/Admin user detected:', {
                            userType: userType,
                            userId: userId,
                            action: recaptchaAction
                        });
                    } else {
                        recaptchaAction = 'qa_public_submit';
                        userTypeDetected = 'citizen';
                        sourceType = 'member_portal';
                        console.log('üë• Public/Citizen user detected:', {
                            userType: userType,
                            userId: userId,
                            action: recaptchaAction
                        });
                    }

                } catch (userTypeError) {
                    console.warn('‚ö†Ô∏è Error detecting user type:', userTypeError);
                    console.log('üîÑ Falling back to public user');
                    recaptchaAction = 'qa_guest_submit';
                    userTypeDetected = 'guest';
                    sourceType = 'fallback_portal';
                }
            } else {
                console.log('üë§ Guest user detected (not logged in)');
                recaptchaAction = 'qa_guest_submit';
                userTypeDetected = 'guest';
                sourceType = 'guest_portal';
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• source ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ debug
            const additionalSource = {
                page: 'qa_form',
                feature: 'create_topic',
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent.substring(0, 50)
            };

            console.log('üîê Final reCAPTCHA configuration:', {
                action: recaptchaAction,
                userType: userTypeDetected,
                source: sourceType,
                additional: additionalSource
            });

            submitBtn.innerHTML = '<i class="fas fa-shield-alt fa-spin me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...';

            // ‚úÖ Execute reCAPTCHA with correct action
            grecaptcha.execute(window.RECAPTCHA_SITE_KEY, {
                action: recaptchaAction
            })
                .then(function (token) {
                    console.log('‚úÖ reCAPTCHA token received for action:', recaptchaAction);
                    console.log('üìù Token preview:', token.substring(0, 20) + '...');
                    console.log('üìä Token length:', token.length);

                    submitBtn.innerHTML = '<i class="fas fa-paper-plane fa-spin me-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';

                    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° hidden fields ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                    addHiddenField(form, 'g-recaptcha-response', token);
                    addHiddenField(form, 'recaptcha_action', recaptchaAction);
                    addHiddenField(form, 'recaptcha_source', sourceType);
                    addHiddenField(form, 'user_type_detected', userTypeDetected);

                    // ‚úÖ Debug fields
                    addHiddenField(form, 'debug_recaptcha_action', recaptchaAction);
                    addHiddenField(form, 'debug_user_type_detected', userTypeDetected);
                    addHiddenField(form, 'debug_source_type', sourceType);

                    // ‚úÖ Additional context
                    addHiddenField(form, 'form_source', 'qa_submission');
                    addHiddenField(form, 'client_timestamp', additionalSource.timestamp);
                    addHiddenField(form, 'user_agent_info', additionalSource.userAgent);

                    console.log('üìã All form fields added:', {
                        'g-recaptcha-response': token.substring(0, 20) + '...',
                        'recaptcha_action': recaptchaAction,
                        'recaptcha_source': sourceType,
                        'user_type_detected': userTypeDetected
                    });

                    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° token ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
                    performFormSubmission(form, submitBtn, originalContent, token);
                })
                .catch(function (error) {
                    console.error('‚ùå reCAPTCHA Error for action', recaptchaAction + ':', error);
                    resetSubmitButton(submitBtn, originalContent);

                    let errorMessage = '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';

                    if (error.message) {
                        if (error.message.includes('network')) {
                            errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                        } else if (error.message.includes('timeout')) {
                            errorMessage = '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                        } else if (error.message.includes('key')) {
                            errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ reCAPTCHA ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                        }
                    }

                    showAlert('error', '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', errorMessage + ' ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤');
                });

        } catch (error) {
            console.error('‚ùå executeRecaptchaAndSubmit Error:', error);
            resetSubmitButton(submitBtn, originalContent);
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        }
    }


    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: Helper function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° hidden field
    function addHiddenField(form, name, value) {
        try {
            // ‡∏•‡∏ö field ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            const existingField = form.querySelector(`input[name="${name}"]`);
            if (existingField) {
                existingField.remove();
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° field ‡πÉ‡∏´‡∏°‡πà
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = name;
            hiddenField.value = value;
            form.appendChild(hiddenField);

            console.log(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° hidden field: ${name} = ${value}`);
            return true;
        } catch (error) {
            console.error('‚ùå Error adding hidden field:', error);
            return false;
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏£‡∏¥‡∏á

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô reset submit button
    function resetSubmitButton(submitBtn, originalContent) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalContent;
        formSubmitting = false;
    }
    function performFormSubmission(form, submitBtn, originalContent, recaptchaToken) {
        try {
            console.log('üöÄ Starting form submission with complete data...');

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° form token
            const formToken = generateFormToken();
            const tokenField = document.getElementById('formToken');
            if (tokenField) {
                tokenField.value = formToken;
            }

            const formData = new FormData();

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];

                if (element.type === 'file' || element.type === 'button' || element.type === 'submit') {
                    continue;
                }

                if (element.name && element.value !== '') {
                    formData.append(element.name, element.value);
                    console.log(`üìù Form field: ${element.name} = ${element.value}`);
                }
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (typeof selectedFiles !== 'undefined' && selectedFiles.length > 0) {
                selectedFiles.forEach((file, index) => {
                    formData.append('q_a_imgs[]', file);
                    console.log(`üìé File ${index + 1}: ${file.name} (${file.size} bytes)`);
                });
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° reCAPTCHA ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• source ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            if (recaptchaToken) {
                // Token
                formData.append('g-recaptcha-response', recaptchaToken);

                // Source information
                const sourceType = form.querySelector('input[name="recaptcha_source"]')?.value || 'unknown';
                const actionType = form.querySelector('input[name="recaptcha_action"]')?.value || 'unknown';
                const userType = form.querySelector('input[name="user_type_detected"]')?.value || 'unknown';

                formData.append('recaptcha_source', sourceType);
                formData.append('recaptcha_action', actionType);
                formData.append('user_type_detected', userType);

                console.log('‚úÖ reCAPTCHA data added to form:', {
                    token_length: recaptchaToken.length,
                    source: sourceType,
                    action: actionType,
                    user_type: userType
                });
            } else {
                console.log('‚ö†Ô∏è No reCAPTCHA token (Development mode)');
                formData.append('skip_recaptcha', '1');
            }

            // ‚úÖ ‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ Controller ‡∏™‡πà‡∏á JSON response
            formData.append('ajax_request', '1');

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
            formData.append('js_debug_info', JSON.stringify({
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent.substring(0, 100),
                screen_resolution: `${screen.width}x${screen.height}`,
                page_url: window.location.href
            }));

            console.log('üì® Sending form data to:', form.action);

            // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                body: formData
            })
                .then(response => {
                    console.log('üì• Response received:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: response.url
                    });

                    const contentType = response.headers.get('content-type');
                    console.log('üìã Content-Type:', contentType);

                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(jsonData => {
                            console.log('üìä JSON Response:', jsonData);
                            return handleJsonResponse(jsonData);
                        });
                    } else {
                        return response.text().then(text => {
                            console.log('üìÑ HTML/Text Response length:', text.length);
                            return handleHtmlResponse(text, response);
                        });
                    }
                })
                .then(result => {
                    if (result && result.handled === true) {
                        console.log('‚úÖ Response handled successfully');
                        return;
                    }

                    // Fallback success handling
                    console.log('üîÑ Using fallback success handling');
                    showAlert('success', '‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    resetFormAfterSubmit();
                    setTimeout(() => {
                        window.location.href = '<?= site_url("Pages/q_a"); ?>';
                    }, 2000);
                })
                .catch(error => {
                    console.error('‚ùå Fetch error:', error);
                    handleSubmissionError(error);
                })
                .finally(() => {
                    resetSubmitButton(submitBtn, originalContent);
                });

        } catch (error) {
            console.error('‚ùå performFormSubmission error:', error);
            resetSubmitButton(submitBtn, originalContent);
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        }
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ JSON response
    function handleJsonResponse(jsonData) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö reCAPTCHA error
        if (jsonData.error_type === 'recaptcha_missing' || jsonData.error_type === 'recaptcha_failed') {
            console.log('‚ùå reCAPTCHA Error:', jsonData.message);
            showAlert('warning', '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', jsonData.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
            return { handled: true };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL detection ‡πÉ‡∏ô JSON
        if (jsonData.has_url === true ||
            jsonData.url_detected === true ||
            jsonData.block_submit === true) {
            console.log('URL detected via JSON:', jsonData.url_detected_fields || jsonData.url_fields || []);
            showUrlErrorModal(
                jsonData.url_detected_fields || jsonData.url_fields || [],
                jsonData.message || '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'
            );
            return { handled: true };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö vulgar_detected ‡πÉ‡∏ô JSON
        if (jsonData.vulgar_detected === true || jsonData.has_vulgar === true) {
            console.log('Vulgar detected via JSON:', jsonData.vulgar_words);
            showVulgarErrorModalWithWords(jsonData.vulgar_words || []);
            return { handled: true };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö success/error ‡πÉ‡∏ô JSON
        if (jsonData.success === false) {
            if (jsonData.error_type === 'url_content') {
                showUrlErrorModal(
                    jsonData.url_fields || [],
                    jsonData.message || '‡∏û‡∏ö URL ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'
                );
                return { handled: true };
            }

            if (jsonData.error_type === 'vulgar_content') {
                showVulgarErrorModalWithWords(jsonData.vulgar_words || []);
                return { handled: true };
            }

            throw new Error(jsonData.message || 'Server error');
        }

        if (jsonData.success === true) {
            showAlert('success', '‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', jsonData.message || '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            resetFormAfterSubmit();
            setTimeout(() => {
                window.location.href = '<?= site_url("Pages/q_a"); ?>';
            }, 2000);
            return { handled: true };
        }

        return { handled: false, data: jsonData };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ HTML response
    function handleHtmlResponse(text, response) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL detection ‡πÉ‡∏ô HTML response
        if (text.includes('has_url') ||
            text.includes('url_detected') ||
            text.includes('block_submit') ||
            text.includes('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ URL') ||
            text.includes('check_no_urls') ||
            text.includes('URL-like pattern found')) {

            console.log('URL content detected in HTML response');

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á URL fields ‡∏à‡∏≤‡∏Å HTML
            let urlFields = [];
            try {
                const urlFieldsMatch = text.match(/url_detected_fields['"]\s*:\s*\[(.*?)\]/);
                if (urlFieldsMatch && urlFieldsMatch[1]) {
                    urlFields = urlFieldsMatch[1]
                        .split(',')
                        .map(field => field.replace(/['"]/g, '').trim())
                        .filter(field => field.length > 0);
                }
            } catch (e) {
                console.log('Could not extract URL fields from HTML');
            }

            showUrlErrorModal(urlFields, '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            return { handled: true };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PHP Session Flash Messages ‡πÉ‡∏ô HTML
        if (text.includes('save_vulgar') ||
            text.includes('vulgar_words') ||
            text.includes('‡∏û‡∏ö‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°') ||
            text.includes('vulgar')) {

            console.log('Vulgar content detected in HTML response');

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á vulgar words ‡∏à‡∏≤‡∏Å HTML ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            let vulgarWords = [];
            try {
                const vulgarMatch = text.match(/vulgar_words['"]\s*:\s*\[(.*?)\]/);
                if (vulgarMatch && vulgarMatch[1]) {
                    vulgarWords = vulgarMatch[1]
                        .split(',')
                        .map(word => word.replace(/['"]/g, '').trim())
                        .filter(word => word.length > 0);
                }
            } catch (e) {
                console.log('Could not extract vulgar words from HTML');
            }

            showVulgarErrorModalWithWords(vulgarWords);
            return { handled: true };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö redirect ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if (response.ok && (response.url.includes('/q_a') || text.includes('q_a'))) {
            console.log('Successful redirect detected');
            showAlert('success', '‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            resetFormAfterSubmit();
            setTimeout(() => {
                window.location.href = '<?= site_url("Pages/q_a"); ?>';
            }, 2000);
            return { handled: true };
        }

        return { handled: false, text: text };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error
    function handleSubmissionError(error) {
        let errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó error
        if (error.message.includes('URL') ||
            error.message.includes('url') ||
            error.message.includes('‡∏•‡∏¥‡∏á‡∏Å‡πå')) {
            showUrlErrorModal([], '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');
        } else if (error.message.includes('vulgar') || error.message.includes('‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°')) {
            showVulgarErrorModal();
        } else if (error.message.includes('reCAPTCHA') || error.message.includes('recaptcha')) {
            showAlert('warning', '‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤');
        } else {
            showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', errorMessage);
        }
    }

    function showVulgarErrorModal() {
        Swal.fire({
            icon: 'error',
            title: '‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
            html: `
            <div style="text-align: left; padding: 1rem;">
                <p style="margin-bottom: 1rem; color: #721c24;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ</strong>
                </p>
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #721c24; font-size: 0.95rem;">
                        üìù <strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                    </p>
                </div>
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 1rem;">
                    <p style="margin: 0; color: #0c5460; font-size: 0.9rem;">
                        üí° <strong>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </p>
                </div>
            </div>
        `,
            confirmButtonColor: '#dc3545',
            confirmButtonText: '<i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
            allowOutsideClick: false,
            customClass: {
                popup: 'vulgar-error-modal',
                title: 'vulgar-error-title',
                htmlContainer: 'vulgar-error-content'
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠ decode Unicode escape sequences ‡πÅ‡∏•‡∏∞ HTML entities
    function decodeWord(word) {
        try {
            console.log('üîç Decoding word:', word);

            let decodedWord = word;

            // 1. Decode Unicode escape sequences (\u0e2a\u0e38\u0e20\u0e32\u0e1e)
            if (decodedWord.includes('\\u')) {
                try {
                    decodedWord = JSON.parse('"' + decodedWord + '"');
                    console.log('üìù Unicode decoded:', decodedWord);
                } catch (e) {
                    console.log('‚ö†Ô∏è Unicode decode failed:', e.message);
                }
            }

            // 2. Decode HTML entities (&amp;, &lt;, &gt;, etc.)
            if (decodedWord.includes('&')) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = decodedWord;
                decodedWord = tempDiv.textContent || tempDiv.innerText || decodedWord;
                console.log('üìù HTML entity decoded:', decodedWord);
            }

            // 3. Decode URL encoding (%20, %E0%B8%AA, etc.)
            if (decodedWord.includes('%')) {
                try {
                    decodedWord = decodeURIComponent(decodedWord);
                    console.log('üìù URL decoded:', decodedWord);
                } catch (e) {
                    console.log('‚ö†Ô∏è URL decode failed:', e.message);
                }
            }

            // 4. Trim whitespace
            decodedWord = decodedWord.trim();

            console.log('‚úÖ Final decoded word:', decodedWord);
            return decodedWord;

        } catch (error) {
            console.error('‚ùå Error decoding word:', word, error);
            return word; // Return original if decoding fails
        }
    }


    function showVulgarErrorModalWithWords(vulgarWords = []) {
        console.log('üö® showVulgarErrorModalWithWords called with:', vulgarWords);

        let wordsHtml = '';
        let processedWords = [];

        if (vulgarWords && vulgarWords.length > 0) {
            // Process ‡πÅ‡∏•‡∏∞ decode ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥
            processedWords = vulgarWords.map(word => {
                const originalWord = word;
                const decodedWord = decodeWord(word);

                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á original ‡πÅ‡∏•‡∏∞ decoded ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£ debug
                return {
                    original: originalWord,
                    decoded: decodedWord,
                    display: decodedWord || originalWord // ‡πÉ‡∏ä‡πâ decoded ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ original
                };
            });

            console.log('üìã Processed words:', processedWords);

            wordsHtml = `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                <p style="margin: 0 0 0.5rem 0; color: #856404; font-weight: bold;">
                    üö´ <strong>‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:</strong>
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${processedWords.map(wordObj => `
                        <span style="
                            background: #f8d7da; 
                            color: #721c24; 
                            padding: 0.3rem 0.6rem; 
                            border-radius: 15px; 
                            font-size: 0.85rem;
                            border: 1px solid #f5c6cb;
                        " title="Original: ${wordObj.original}">${wordObj.display}</span>
                    `).join('')}
                </div>
            </div>
        `;
        }

        Swal.fire({
            icon: 'error',
            title: '‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
            html: `
            <div style="text-align: left; padding: 1rem;">
                <p style="margin-bottom: 1rem; color: #721c24;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ</strong>
                </p>
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #721c24; font-size: 0.95rem;">
                        üìù <strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                    </p>
                </div>
                ${wordsHtml}
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 1rem;">
                    <p style="margin: 0; color: #0c5460; font-size: 0.9rem;">
                        üí° <strong>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </p>
                </div>
            </div>
        `,
            confirmButtonColor: '#dc3545',
            confirmButtonText: '<i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
            allowOutsideClick: false,
            customClass: {
                popup: 'vulgar-error-modal',
                title: 'vulgar-error-title',
                htmlContainer: 'vulgar-error-content'
            },
            width: '600px'
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á Modal ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô URL
    function showUrlErrorModal(urlFields = [], message = '') {
        console.log('üö® showUrlErrorModal called with fields:', urlFields, 'message:', message);

        let fieldsHtml = '';

        if (urlFields && urlFields.length > 0) {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            const fieldNames = {
                'q_a_msg': '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°',
                'q_a_detail': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°',
                'q_a_by': '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏≤‡∏°',
                'q_a_reply_detail': '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö',
                'q_a_reply_by': '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö'
            };

            const displayFields = urlFields.map(field => fieldNames[field] || field);

            fieldsHtml = `
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                <p style="margin: 0 0 0.5rem 0; color: #856404; font-weight: bold;">
                    üéØ <strong>‡∏û‡∏ö URL ‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå:</strong>
                </p>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${displayFields.map(field => `
                        <span style="
                            background: #ffeaa7; 
                            color: #856404; 
                            padding: 0.3rem 0.6rem; 
                            border-radius: 15px; 
                            font-size: 0.85rem;
                            border: 1px solid #fdcb6e;
                            font-weight: 500;
                        ">${field}</span>
                    `).join('')}
                </div>
            </div>
        `;
        }

        const displayMessage = message || '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏°‡∏µ URL ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';

        Swal.fire({
            icon: 'warning',
            title: 'üîó ‡∏û‡∏ö URL ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
            html: `
            <div style="text-align: left; padding: 1rem;">
                <p style="margin-bottom: 1rem; color: #856404;">
                    <i class="fas fa-link me-2"></i>
                    <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ</strong>
                </p>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #856404; font-size: 0.95rem;">
                        üö´ <strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${displayMessage}
                    </p>
                </div>
                ${fieldsHtml}
                <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 1rem;">
                    <p style="margin: 0; color: #0c5460; font-size: 0.9rem;">
                        üí° <strong>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏ö URL, ‡∏•‡∏¥‡∏á‡∏Å‡πå, ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </p>
                </div>
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <p style="margin: 0; color: #6c757d; font-size: 0.85rem;">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</strong> google.com, www.facebook.com, https://example.com
                    </p>
                </div>
            </div>
        `,
            confirmButtonColor: '#ffc107',
            confirmButtonText: '<i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',
            allowOutsideClick: false,
            customClass: {
                popup: 'url-error-modal',
                title: 'url-error-title',
                htmlContainer: 'url-error-content'
            },
            width: '600px'
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ AJAX Response
    function handleAjaxResponse(response) {
        console.log('üì® AJAX Response received:', response);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL Detection ‡∏Å‡πà‡∏≠‡∏ô
        if (response.url_detected === true) {
            console.log('üîó URL detected, showing URL error modal');
            showUrlErrorModal(response.url_fields || [], response.message || '');
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Vulgar Detection
        if (response.vulgar_detected === true) {
            console.log('üö´ Vulgar content detected, showing vulgar error modal');
            showVulgarErrorModalWithWords(response.vulgar_words || []);
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Validation Error
        if (response.validation_error === true) {
            console.log('üìù Validation error detected');
            Swal.fire({
                icon: 'warning',
                title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                text: response.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                confirmButtonColor: '#ffc107',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            });
            return;
        }

        // Success case
        if (response.success === true) {
            console.log('‚úÖ Success response');
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: response.message || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirmButtonColor: '#28a745',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
            }).then(() => {
                // Redirect ‡∏´‡∏£‡∏∑‡∏≠ refresh ‡∏´‡∏ô‡πâ‡∏≤
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    window.location.reload();
                }
            });
            return;
        }

        // Generic error case
        console.log('‚ùå Generic error response');
        Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: response.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
            confirmButtonColor: '#dc3545',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
        });
    }

    // ============================================
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal
    // ============================================

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <style> tag ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
    const vulgarModalStyles = `
<style>
.vulgar-error-modal {
    border-radius: 20px !important;
    box-shadow: 0 20px 60px rgba(220, 53, 69, 0.3) !important;
}

.vulgar-error-title {
    color: #721c24 !important;
    font-size: 1.4rem !important;
    font-weight: 700 !important;
}

.vulgar-error-content {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
}

.swal2-confirm.swal2-styled {
    border-radius: 12px !important;
    font-weight: 600 !important;
    padding: 0.7rem 1.5rem !important;
    transition: all 0.3s ease !important;
}

.swal2-confirm.swal2-styled:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4) !important;
}
</style>
`;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô head
    document.head.insertAdjacentHTML('beforeend', vulgarModalStyles);




    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô reset form ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    function resetFormAfterSubmit() {
        try {
            const form = document.getElementById('qaForm');
            if (form) {
                form.reset();
            }

            selectedFiles = [];
            updateFileDisplay();

            const fileInput = document.getElementById('q_a_imgs');
            if (fileInput) {
                fileInput.value = '';
                fileInput._processing = false;
            }

            const tokenField = document.getElementById('formToken');
            if (tokenField) {
                tokenField.value = '';
            }
        } catch (error) {
            console.error('Reset form error:', error);
        }
    }

    // ==============================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    // ==============================================

    function showModal() {
        try {
            const modalElement = document.getElementById('guestConfirmModal');

            if (!modalElement) {
                console.error('Modal element not found');
                return;
            }

            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    guestModalInstance = new bootstrap.Modal(modalElement);
                    guestModalInstance.show();
                    return;
                } catch (e) {
                    console.log('Bootstrap 5 method failed, using fallback:', e);
                }
            }

            // Fallback method
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
            modalElement.style.paddingRight = '15px';
            document.body.classList.add('modal-open');
            document.body.style.paddingRight = '15px';

            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.setAttribute('data-custom-backdrop', 'true');
                document.body.appendChild(backdrop);
            }
        } catch (error) {
            console.error('Show modal error:', error);
        }
    }

    function hideModal() {
        try {
            const modalElement = document.getElementById('guestConfirmModal');

            if (guestModalInstance && typeof bootstrap !== 'undefined') {
                try {
                    guestModalInstance.hide();
                    guestModalInstance = null;
                    return;
                } catch (e) {
                    console.log('Bootstrap 5 hide failed, using fallback:', e);
                }
            }

            // Fallback method
            if (modalElement) {
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.style.paddingRight = '';
            }

            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';

            const backdrop = document.querySelector('.modal-backdrop[data-custom-backdrop="true"]');
            if (backdrop) {
                backdrop.remove();
            }
        } catch (error) {
            console.error('Hide modal error:', error);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà login
    function proceedAsGuest() {
        try {
            hasConfirmedAsGuest = true;
            hideModal();
            showAlert('info', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß', 2000);
        } catch (error) {
            console.error('Proceed as guest error:', error);
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
    function redirectToLogin() {
        try {
            hideModal();
            const currentUrl = window.location.href;
            sessionStorage.setItem('redirect_after_login', currentUrl);
            // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ï‡∏≤‡∏° CodeIgniter 3
            window.open('/User', '_blank');
        } catch (error) {
            console.error('Redirect to login error:', error);
            // fallback
            window.open('/User', '_blank');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á welcome message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡∏ó‡∏µ‡πà login ‡πÅ‡∏•‡πâ‡∏ß
    function showWelcomeMessageIfLoggedIn() {
        try {
            if (isUserLoggedIn && userInfo) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
                let userName = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';

                if (userInfo.user_info && userInfo.user_info.name) {
                    userName = userInfo.user_info.name;
                } else if (userInfo.name) {
                    userName = userInfo.name;
                }

                Swal.fire({
                    icon: 'success',
                    title: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${userName}`,
                    text: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true,
                    background: 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)',
                    color: '#155724'
                });
            }
        } catch (error) {
            console.error('Show welcome message error:', error);
        }
    }

    // ==============================================
    // Event Listeners - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    // ==============================================

    document.addEventListener('DOMContentLoaded', function () {
        try {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô default form submission
            const form = document.getElementById('qaForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    return false;
                });
            }

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó form fields ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ login
            updateFormFieldsBasedOnLoginStatus();

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ upload wrapper
            let uploadWrapperInitialized = false;

            document.addEventListener('dragover', function (e) {
                e.preventDefault();
            });

            document.addEventListener('drop', function (e) {
                e.preventDefault();
            });

            const uploadWrapper = document.querySelector('.file-upload-wrapper');
            if (uploadWrapper && !uploadWrapperInitialized) {
                uploadWrapper.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const fileInput = document.getElementById('q_a_imgs');
                    if (fileInput) {
                        fileInput.click();
                    }
                });
                uploadWrapperInitialized = true;
            }

            // ‡πÅ‡∏™‡∏î‡∏á modal ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login
            if (!isUserLoggedIn) {
                setTimeout(function () {
                    if (!hasConfirmedAsGuest) {
                        showModal();
                    }
                }, 1000);
            } else {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡∏ó‡∏µ‡πà login ‡πÅ‡∏•‡πâ‡∏ß
                setTimeout(function () {
                    showWelcomeMessageIfLoggedIn();
                }, 500);
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            const formContainer = document.querySelector('.container-pages-news');
            if (formContainer) {
                formContainer.style.opacity = '0';
                formContainer.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    formContainer.style.transition = 'all 0.6s ease';
                    formContainer.style.opacity = '1';
                    formContainer.style.transform = 'translateY(0)';
                }, 100);
            }

            console.log('‚úÖ Page initialized successfully');

        } catch (error) {
            console.error('DOMContentLoaded error:', error);
        }
    });

    // ==============================================
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    // ==============================================

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏à‡∏≤‡∏Å browser extension
    if (typeof chrome !== 'undefined' && chrome.runtime) {
        try {
            chrome.runtime.onMessage = chrome.runtime.onMessage || function () { };
        } catch (extensionError) {
            console.log('Chrome extension error (ignored):', extensionError);
        }
    }

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô undefined function errors
    window.onerror = function (msg, url, lineNo, columnNo, error) {
        if (msg.includes('check_login_status') || msg.includes('message channel')) {
            console.log('Ignored error:', msg);
            return true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á error ‡πÉ‡∏ô console
        }
        return false;
    };

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Promise rejection errors
    window.addEventListener('unhandledrejection', function (event) {
        if (event.reason && event.reason.message &&
            (event.reason.message.includes('message channel') ||
                event.reason.message.includes('check_login_status'))) {
            console.log('Ignored promise rejection:', event.reason);
            event.preventDefault();
        }
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á global variables ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    window.isUserLoggedIn = isUserLoggedIn;
    window.userInfo = userInfo;
    window.hasConfirmedAsGuest = hasConfirmedAsGuest;

    console.log('üõ°Ô∏è Error protection initialized');
    console.log('‚úÖ All systems ready');

</script>